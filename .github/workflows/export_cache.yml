name: Export All Track Data Caches
on: 
  workflow_dispatch:

permissions:
  actions: read
  contents: read

jobs:
  # 第一步：获取所有匹配的 Key 列表
  list-keys:
    runs-on: ubuntu-latest
    outputs:
      keys: ${{ steps.get-keys.outputs.keys }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4 # 必须加上这一步，否则 gh 命令会报错

      - id: get-keys
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 获取前 10 个以 track_data- 开头的 key
          KEYS=$(gh cache list --limit 10 --json key --jq '[.[].key | select(startswith("track_data-"))]')
          echo "Found keys: $KEYS"
          echo "keys=$KEYS" >> "$GITHUB_OUTPUT"

  # 第二步：循环导出每个缓存并存为 Artifact
  export-files:
    needs: list-keys
    runs-on: ubuntu-latest
    if: needs.list-keys.outputs.keys != '[]' && needs.list-keys.outputs.keys != ''
    strategy:
      matrix:
        cache_key: ${{ fromJson(needs.list-keys.outputs.keys) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore Cache
        uses: actions/cache/restore@v4
        with:
          path: |
            data.db
            assets/
            imported.json
          key: ${{ matrix.cache_key }}

      - name: Prepare Folder
        run: |
          # 创建以 Key 命名的唯一文件夹
          DIR="export_${{ matrix.cache_key }}"
          mkdir -p "$DIR"
          [ -f data.db ] && cp data.db "$DIR/"
          [ -d assets ] && cp -r assets "$DIR/"
          [ -f imported.json ] && cp imported.json "$DIR/"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.cache_key }}
          path: export_${{ matrix.cache_key }}/
          retention-days: 1