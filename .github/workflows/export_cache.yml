name: Export All Track Data Caches
on: 
  workflow_dispatch:

permissions:
  actions: read
  contents: read

jobs:
  export-all:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: List and Download All Caches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. 获取 Cache Key 列表
          KEYS=$(gh cache list --limit 100 --json key --jq '.[] | .key' | grep "^track_data-")

          if [ -z "$KEYS" ]; then
            echo "No caches found starting with track_data-"
            exit 0
          fi

          echo "Found caches: $KEYS"

          # 2. 循环处理
          for KEY in $KEYS; do
            echo "Downloading $KEY..."
            # 创建对应 Key 的存放目录
            TARGET_DIR="output/$KEY"
            mkdir -p "$TARGET_DIR"
            
            # 使用更兼容的命令：先进入目录，再执行下载
            # gh cache download 默认会将缓存下载为以 key 命名的 .zip 文件
            (cd "$TARGET_DIR" && gh cache download "$KEY" -R ${{ github.repository }})
            
            # 自动解压并删除原 zip (方便你直接查看内容)
            if [ -f "$TARGET_DIR/$KEY.zip" ]; then
                unzip -o "$TARGET_DIR/$KEY.zip" -d "$TARGET_DIR"
                rm "$TARGET_DIR/$KEY.zip"
            fi
          done

      - name: Upload All as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-track-data-backups
          path: output/
          retention-days: 5