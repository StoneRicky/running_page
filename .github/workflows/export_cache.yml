name: Export All Track Data Caches
on: 
  workflow_dispatch:

permissions:
  actions: write # 需要权限读取和操作缓存
  contents: read

jobs:
  # 第一步：先找出所有的 Cache Keys
  list-keys:
    runs-on: ubuntu-latest
    outputs:
      keys: ${{ steps.get-keys.outputs.keys }}
    steps:
      - id: get-keys
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 获取前 10 个匹配 track_data 的 key，转成 JSON 数组格式
          KEYS=$(gh cache list --limit 10 --json key --jq '[.[].key | select(startswith("track_data-"))]')
          echo "keys=$KEYS" >> "$GITHUB_OUTPUT"

  # 第二步：根据找出的 Keys 矩阵式导出
  export-files:
    needs: list-keys
    runs-on: ubuntu-latest
    if: needs.list-keys.outputs.keys != '[]'
    strategy:
      matrix:
        cache_key: ${{ fromJson(needs.list-keys.outputs.keys) }}
    steps:
      - name: Restore Cache
        uses: actions/cache/restore@v4
        with:
          path: |
            data.db
            assets/
            imported.json
          key: ${{ matrix.cache_key }}

      - name: Prepare Folder
        run: |
          mkdir -p "export/${{ matrix.cache_key }}"
          # 移动文件到对应 key 的文件夹
          cp data.db "export/${{ matrix.cache_key }}/" || true
          cp -r assets "export/${{ matrix.cache_key }}/" || true
          cp imported.json "export/${{ matrix.cache_key }}/" || true

      - name: Upload Single Cache
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.cache_key }}
          path: export/${{ matrix.cache_key }}/
          retention-days: 1